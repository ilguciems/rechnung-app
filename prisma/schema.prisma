// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum LegalForm {
  KLEINGEWERBE
  FREIBERUFLER
  GBR
  EINZELKAUFMANN
  OHG
  KG
  GMBH_CO_KG
  GMBH
  UG
  AG
  KGaA
  SE
  EWIV
}

enum OrgRole {
  admin
  member
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  DOWNLOAD
  SEND
}

enum ActivityEntity {
  INVOICE
  COMPANY
  CUSTOMER
  USER
  EMAIL
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]

  role       String?
  banned     Boolean?
  banReason  String?
  banExpires DateTime?

  memberships   OrganizationMember[]
  organizations Organization[]
  activityLogs  ActivityLog[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  members             OrganizationMember[]
  mailjet             MailjetConfig?
  organizationInvites OrganizationInvite[]
  activityLogs        ActivityLog[]

  @@map("organization")
}

model OrganizationMember {
  id             String  @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole // admin or member

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_member")
}

model MailjetConfig {
  id             String @id @default(cuid())
  organizationId String @unique

  publicKeyEnc  String
  privateKeyEnc String
  fromEmail     String
  fromName      String

  isEnabled Boolean @default(false)

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("mailjet_config")
}

model OrganizationInvite {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole
  token          String    @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("organization_invite")
}

model Company {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  street      String
  houseNumber String
  zipCode     String
  city        String
  country     String @default("Deutschland")

  phone   String
  email   String
  iban    String
  bic     String
  bank    String
  logoUrl String?

  isSubjectToVAT Boolean @default(false)
  firstTaxRate   Float?
  secondTaxRate  Float?

  legalForm LegalForm @default(KLEINGEWERBE)

  steuernummer          String?
  ustId                 String?
  handelsregisternummer String?

  invoices         Invoice[]
  companySnapshots CompanySnapshot[]
  organizations    Organization[]
  activityLogs     ActivityLog[]

  @@index([createdAt])
  @@index([updatedAt])
  @@map("company")
}

model CompanySnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  name        String
  street      String
  houseNumber String
  zipCode     String
  city        String
  country     String

  phone   String
  email   String
  iban    String
  bic     String
  bank    String
  logoUrl String?

  isSubjectToVAT Boolean
  firstTaxRate   Float?
  secondTaxRate  Float?

  legalForm LegalForm

  steuernummer          String?
  ustId                 String?
  handelsregisternummer String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  invoices Invoice[]

  @@index([createdAt])
  @@map("company_snapshot")
}

model Invoice {
  id             String  @unique @default(cuid())
  invoiceNumber  String  @unique
  customerName   String
  customerNumber String?

  customerStreet      String
  customerHouseNumber String
  customerZipCode     String
  customerCity        String
  customerCountry     String @default("Deutschland")

  customerEmail String?
  customerPhone String?

  createdAt DateTime  @default(now())
  isPaid    Boolean   @default(false)
  paidAt    DateTime?

  items             Item[]
  companyId         String
  company           Company          @relation(fields: [companyId], references: [id])
  companySnapshot   CompanySnapshot? @relation(fields: [companySnapshotId], references: [id])
  companySnapshotId String?

  @@index([createdAt])
  @@map("invoice")
}

model Item {
  id          String  @id @default(cuid())
  description String
  quantity    Int
  unitPrice   Float
  taxRate     Float?
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])

  @@map("item")
}

model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  action     ActivityAction
  entityType ActivityEntity
  entityId   String?

  metadata Json?

  @@index([createdAt])
  @@index([userId])
  @@index([organizationId])
  @@index([companyId])
  @@map("activity_log")
}
